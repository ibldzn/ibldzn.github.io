<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Disabling ‘Dying Walk’ in Yakuza Kiwami" /><meta name="author" content="ibldzn" /><meta property="og:locale" content="en_US" /><meta name="description" content="Kiryu having stomachache" /><meta property="og:description" content="Kiryu having stomachache" /><link rel="canonical" href="https://ibldzn.github.io/posts/disabling-dying-walk-kiwami/" /><meta property="og:url" content="https://ibldzn.github.io/posts/disabling-dying-walk-kiwami/" /><meta property="og:site_name" content="ibl[og]dzn" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-04-08T09:15:21+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Disabling ‘Dying Walk’ in Yakuza Kiwami" /><meta name="twitter:site" content="@ibldzn" /><meta name="twitter:creator" content="@ibldzn" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"ibldzn"},"description":"Kiryu having stomachache","url":"https://ibldzn.github.io/posts/disabling-dying-walk-kiwami/","@type":"BlogPosting","headline":"Disabling ‘Dying Walk’ in Yakuza Kiwami","dateModified":"2021-04-15T12:04:12+07:00","datePublished":"2021-04-08T09:15:21+07:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://ibldzn.github.io/posts/disabling-dying-walk-kiwami/"},"@context":"https://schema.org"}</script><title>Disabling 'Dying Walk' in Yakuza Kiwami | ibl[og]dzn</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://i.pinimg.com/originals/35/77/97/35779715c7f157cfbdc113b5ee70e13d.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ibl[og]dzn</a></div><div class="site-subtitle font-italic">...</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ibldzn" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/ibldzn" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['notadummy21','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Disabling 'Dying Walk' in Yakuza Kiwami</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Disabling 'Dying Walk' in Yakuza Kiwami</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> ibldzn </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Apr 8, 2021, 9:15 AM +0700" prep="on" > Apr 8 <i class="unloaded">2021-04-08T09:15:21+07:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Apr 15, 2021, 12:04 PM +0700" prefix="Updated " > Apr 15 <i class="unloaded">2021-04-15T12:04:12+07:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1541 words">8 min</span></div></div><div class="post-content"><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/keRam7j.png" alt="Kiryu Dying" class="center" /> <em>Kiryu having stomachache</em></p><h1 id="introduction">Introduction</h1><hr /><p>I recently installed Yakuza Kiwami again just because I miss <del>ab</del>using <a href="https://yakuza.fandom.com/wiki/Komaki_Tiger_Drop">Tiger Drop</a>.</p><p>They nerfed this move in the next series released after Yakuza Kiwami because how overpowered it was, not to mention you can literally <a href="https://youtu.be/rFlmc8Mr8Qg">one hit</a> bosses with 4 health bar if you buff yourself using <a href="https://yakuza-archive.fandom.com/wiki/Time_for_Destruction">Time For Destruction</a>, equipping <a href="https://i.imgur.com/dxRrTZn.png">Payback Ring</a> and <a href="https://i.imgur.com/9WKnCLa.png">Dojima Family Amulet</a> while having low health.</p><p>Because I love <del>ab</del>using this move so much, I prefer walking around town with low health to instantly finish <a href="https://yakuza.fandom.com/wiki/Majima_Everywhere">Majima Everywhere</a> fight, but the problem is once your health is so low to the point the health bar is flashing Kiryu will do this <a href="https://i.imgur.com/857Nkga.gif">“Dying Walk”</a> which completely slow down your movement speed and not allowing you to run at all.</p><h1 id="into-the-fun-part">Into the fun part</h1><hr /><p>To find out how the game decide when Kiryu should do that “Dying Walk” we first need to find where’s our health laid in memory, the game has to access it somewhere if Kiryu only does that walk everytime his health is flashing.</p><p>I’ve actually reverse engineered the game a little bit a few months ago to make this <a href="https://github.com/ibldzn/yakuza-kiwami-heat">simple mod</a> that fills your heat bar after pressing R3 and completely deplete your heat after pressing L3. Having this <a href="https://github.com/ibldzn/yakuza-kiwami-heat/blob/1f1bf3d4ce5d28f3052c570718edd8e9c31b322b/yakuza-kiwami-heat/src/hooks/hooks.cpp#L7">information</a> with me, it’s easy for me to locate that function, again. Also, <a href="https://www.unknowncheats.me/forum/general-programming-and-reversing/171994-understanding-pattern-scanning-concept.html">this</a> is a great writeup if you want to understand how pattern scanning works.</p><p>I found the so called “heat_manager” function which gets called every tick when you’re in a fight. Here’s the dissasembled code</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/XjINQL6.png" alt="Dissasembled Code" /></p><p><code class="language-plaintext highlighter-rouge">player</code> is a pointer to a struct holding all of player’s data, by adding <code class="language-plaintext highlighter-rouge">0x1C</code> to the <code class="language-plaintext highlighter-rouge">player</code> pointer and reading the value as a float we get our current heat value, that being the case it is more than likely our health is somewhere in that struct.</p><h1 id="hunting-where-our-health-is-in-memory">Hunting where our health is in memory</h1><hr /><p>Yakuza Kiwami doesn’t have <a href="https://en.wikipedia.org/wiki/Address_space_layout_randomization">ASLR</a> enabled, thus making it easier for me to move from decompiler to debugger without having to rebase anything.</p><p>Decompiler said the <code class="language-plaintext highlighter-rouge">*(float *)(player + 0x1C) = amount;</code> line we see above is at <code class="language-plaintext highlighter-rouge">0x000000014047A272</code></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/pCNKxiY.png" alt="Address" /></p><p>Our <code class="language-plaintext highlighter-rouge">player</code> pointer is stored inside <code class="language-plaintext highlighter-rouge">rax</code> register, we should get whatever is in the <code class="language-plaintext highlighter-rouge">rax</code> register when this line gets executed, let’s put a breakpoint at the address I’ve mentioned above and get into a fight in-game.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/LxhFjvX.png" alt="Breakpoint Hit" /> <em>We hit the breakpoint</em></p><p><code class="language-plaintext highlighter-rouge">0x00007FF4D0AF2970</code> inside the <code class="language-plaintext highlighter-rouge">rax</code> register is pointing to our <code class="language-plaintext highlighter-rouge">player</code> struct, let’s open up the <code class="language-plaintext highlighter-rouge">Dissect data/structure</code> menu in Cheat Engine and put the value we just got into the address tab, aanndd..</p><h2 id="we-got-our-player-struct">We got our player struct</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/n9vLdKS.png" alt="Player Struct" /></p><p>There are bunches of 0 and unknown value there, but we know for sure that <code class="language-plaintext highlighter-rouge">0x1C</code> is where our heat value is stored, let’s label it.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/03mtpfz.png" alt="Heat Label" /></p><h2 id="we-found-our-possible-health-value">We found our [possible] health value</h2><p>After getting hit by enemy in-game and drinking “health potion” the value at offset <code class="language-plaintext highlighter-rouge">0x14</code> changes, this is very likely to be our health!</p><p>Let’s add it to our address list</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/FDqNgAd.png" alt="Adding Health Address to Address List" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/roTGHYy.png" alt="Health Address in Address List" /> <em>Such a weird value for a health, huh?</em></p><h1 id="lets-find-out-what-accesses-our-health-value">Let’s find out what accesses our health value</h1><hr /><p>Now that we have our health location in memory, we can right click on that address and click on <code class="language-plaintext highlighter-rouge">Find out what accesses this address</code></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/ThwrRoF.png" alt="Find out what accesses this address" /></p><p>Going back in game for a few seconds then I immediately saw this</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/6oTF0hZ.png" alt="What accesses this address" /></p><p>Let’s gamble our luck with the first one.</p><p>Going to address <code class="language-plaintext highlighter-rouge">0x140319A16</code> in dissassembler points me to this line</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/B14CuV6.png" alt="0x140319A16" /> <em>Hex Mismatch, What???</em></p><p>This function looks interesting, it divides our current <code class="language-plaintext highlighter-rouge">health * 100</code> with something, let’s try spoofing the return value stored in the <code class="language-plaintext highlighter-rouge">xmm0</code> register</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/5GOhmPb.png" alt="xmm0 register" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/7wK1Sbo.gif" alt="Spoofing Success" /></p><p>Oh boy we’re lucky we found this in our first try, if we set the value of the <code class="language-plaintext highlighter-rouge">xmm0</code> register to be <code class="language-plaintext highlighter-rouge">xmm1</code> (the divider), we no longer see the flashing health and we’re able to move normally in game even in low health.</p><p>Let’s refer to that function as <code class="language-plaintext highlighter-rouge">health_something</code> (I don’t have a good naming sense, nor do I know where the game gets the divider value, I’m sorry).</p><h1 id="side-effect">Side effect</h1><hr /><p>Returning big value from <code class="language-plaintext highlighter-rouge">health_something</code> function causes some side effect, We can’t do any heat actions which are only do-able when our health is flashing <a href="https://www.youtube.com/watch?v=D7ov8-uPY6E">(like this one for example)</a>.</p><p>Uh, oh.. What should we do??</p><p>Well, the return value from <code class="language-plaintext highlighter-rouge">health_something</code> must be used from multiple places,</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/yw0npLm.png" alt="xref" /></p><p>and we’re right, finding the cross reference in decompiler shows that function gets called from quite a few places.</p><p>One of those functions must’ve decide whether Kiryu should do the “Dying Walk”, but which one?</p><p>Well, time to fire up <a href="https://x64dbg.com/">x64dbg</a> so we can log the <a href="https://en.wikipedia.org/wiki/Return_statement">return address</a> without needing to resume program execution after breakpoint hit. (not sure if Cheat Engine debugger has this feature).</p><h2 id="narrowing-down-the-call">Narrowing down the call</h2><p>Let’s go to <code class="language-plaintext highlighter-rouge">sub_140319A00</code> (<code class="language-plaintext highlighter-rouge">health_something</code>) in x64dbg, (<code class="language-plaintext highlighter-rouge">sub_</code> is a prefix for <code class="language-plaintext highlighter-rouge">subroutine</code> a.k.a <code class="language-plaintext highlighter-rouge">function</code>, those numbers after the <code class="language-plaintext highlighter-rouge">sub_</code> prefix is the function address, in this case we should go to address <code class="language-plaintext highlighter-rouge">140319A00</code>).</p><p>Let’s put a conditional breakpoint in that address</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/Qh0tbD4.png" alt="Conditional Breakpoint" /></p><p>As we can see in this <a href="https://stackoverflow.com/a/62185229">Stackoverflow answer</a> the function’s return address is pointed by the <code class="language-plaintext highlighter-rouge">RSP</code> register, that means in order to get the actual return address we need to dereference the value at <code class="language-plaintext highlighter-rouge">RSP</code> register. Let’s log <code class="language-plaintext highlighter-rouge">[RSP]</code> value by typing this in the conditional breakpoint setting</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/qI3uLKq.png" alt="Conditonal Breakpoint Setting" /></p><ul><li><code class="language-plaintext highlighter-rouge">Break Condition: 0</code> (We just need to log the value at <code class="language-plaintext highlighter-rouge">[RSP]</code> and we don’t want to go back and forth to x64dbg just to resume execution)<li><code class="language-plaintext highlighter-rouge">Log Text: return address: {p:[RSP]}</code> (A log text with <a href="https://help.x64dbg.com/en/latest/introduction/Formatting.html">x64dbg string formatting</a>)<li><code class="language-plaintext highlighter-rouge">Hit Count: 1264</code> (It’s just how many times this line gets executed since we placed the breakpoint)</ul><p>Going to the <code class="language-plaintext highlighter-rouge">Log</code> tab in x64dbg, we immediately see a lot of logged value, but it seems like there’s only 2 unique value there</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>...
return address: 0000000140480759
return address: 0000000140480759
return address: 0000000140480759
return address: 00000001404F54E6
return address: 0000000140480759
return address: 0000000140480759
return address: 0000000140480759
return address: 00000001404F54E6
return address: 0000000140480759
return address: 0000000140480759
return address: 0000000140480759
return address: 00000001404F54E6
...
</pre></table></code></div></div><p>Well, let’s first see what’s inside <code class="language-plaintext highlighter-rouge">0000000140480759</code> in dissassembler.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/TcmYVIm.png" alt="0000000140480759" /></p><p>It’s comparing a global variable with the returned value from the <code class="language-plaintext highlighter-rouge">health_something</code> subroutine, could this be the one?! Here’s how the function looks like in asm</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/9GwExka.png" alt="0000000140480759 asm" /></p><p>The line that caught our interest is <a href="https://c9x.me/x86/html/file_module_x86_id_288.html"><code class="language-plaintext highlighter-rouge">setae al</code></a> which is essentially the return value.</p><p>Let’s change it to:</p><ul><li><code class="language-plaintext highlighter-rouge">mov al, 1</code> (<code class="language-plaintext highlighter-rouge">return true;</code>), and<li><code class="language-plaintext highlighter-rouge">mov al, 0</code> (<code class="language-plaintext highlighter-rouge">return false;</code>)</ul><p>and see what happens in game.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/MbXbzS5.gif" alt="return true" /></p><p>Apparently if we return true in that function we’ll see our health bar flashing, but it doesn’t affect the “Dying Walk” at all, and to my surprise you can do any heat actions that requires you to have flashing health bar even though your health is full! We could exploit this by <a href="https://en.wikipedia.org/wiki/Hooking">hooking</a> that function and returning <code class="language-plaintext highlighter-rouge">true</code> or <code class="language-plaintext highlighter-rouge">false</code> whenever we want! Great stuff.</p><p>Here I tried returning false while having low health but the “Dying Walk” is still there, even though my health bar is no longer flashing.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/KxnVMdB.gif" alt="return false" /></p><p>Now that we know what it does, let’s name this function as <code class="language-plaintext highlighter-rouge">should_flash_health_bar</code></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/36Pb0oj.png" alt="should_flash_health_bar" /></p><p>Well, that wasn’t the exact function we’re looking for but we’re glad we found it. Let’s check the other address at <code class="language-plaintext highlighter-rouge">00000001404F54E6</code></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/NcVdCEO.png" alt="00000001404F54E6" /></p><p>It’s comparing against the same global variable used in <code class="language-plaintext highlighter-rouge">should_flash_health_bar</code>! Well, I guess we could safely assume that <code class="language-plaintext highlighter-rouge">dword_140FCE630</code> is a some sort of thresholder value.</p><h2 id="spoofing-the-function-return-value">Spoofing the function return value</h2><p>Again, the function returned a boolean, we could try the same method we used with <code class="language-plaintext highlighter-rouge">should_flash_health_bar</code>, spoofing the return value and see what changes in game..</p><p>Also, here’s how it looks in asm, what caught our interest this time is the <a href="https://c9x.me/x86/html/file_module_x86_id_288.html"><code class="language-plaintext highlighter-rouge">setbe al</code></a> line.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/5sjGuF4.png" alt="00000001404F54E6 asm" /></p><p>Spoofing the return value to be false and theenn…</p><h3 id="dying-walk-is-gone"><a href="https://imgur.com/Slqakdx">“DYING WALK” IS GONE!</a></h3><p>This function’s return value is used to determine if Kiryu should do the “Dying Walk”. Let’s rename <code class="language-plaintext highlighter-rouge">sub_1404F54A0</code> to <code class="language-plaintext highlighter-rouge">should_dying_walk</code>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://i.imgur.com/H3dEvkY.png" alt="should_dying_walk" /></p><h1 id="finishing-up">Finishing Up</h1><hr /><p>Now that we got what we wanted all that’s left is to make the game execute what we want, we could just dump the process with the bytepatch we just did, but that’s such a “hacky” way to do it especially for game hacking, let’s make a DLL that will hook <code class="language-plaintext highlighter-rouge">should_dying_walk</code> and returning false everytime.</p><p>I’m using <a href="https://github.com/TsudaKageyu/minhook">minhook</a> library for this</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;Windows.h&gt;
#include "include/MinHook.h"
</span>
<span class="c1">// function prototype</span>
<span class="k">using</span> <span class="n">fn</span> <span class="o">=</span> <span class="kt">bool</span><span class="p">(</span><span class="kr">__fastcall</span><span class="o">*</span><span class="p">)(</span><span class="n">__int64</span><span class="p">);</span>

<span class="c1">// pointer to the original should_dying_walk</span>
<span class="k">static</span> <span class="n">fn</span> <span class="n">o_should_dying_walk</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>

<span class="kt">bool</span> <span class="kr">__fastcall</span> <span class="nf">hk_should_dying_walk</span><span class="p">(</span><span class="n">__int64</span> <span class="n">a1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// call the original first otherwise it won't work.</span>
  <span class="n">o_should_dying_walk</span><span class="p">(</span><span class="n">a1</span><span class="p">);</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">dwReason</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">dwReason</span> <span class="o">==</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">DisableThreadLibraryCalls</span><span class="p">(</span><span class="n">hModule</span><span class="p">);</span>
    <span class="n">MH_Initialize</span><span class="p">();</span>
    <span class="n">MH_CreateHook</span><span class="p">(</span>
      <span class="c1">// 0x1404F54A0 is the function address for should_dying_walk function.</span>
      <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">LPVOID</span><span class="o">&gt;</span><span class="p">(</span><span class="mh">0x1404F54A0</span><span class="p">),</span>
      <span class="o">&amp;</span><span class="n">hk_should_dying_walk</span><span class="p">,</span>
      <span class="n">reinterpet_cast</span><span class="o">&lt;</span><span class="n">LPVOID</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">o_should_dying_walk</span><span class="p">)</span>
    <span class="p">);</span>
    <span class="n">MH_EnableHook</span><span class="p">(</span><span class="n">MH_ALL_HOOKS</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dwReason</span> <span class="o">==</span> <span class="n">DLL_PROCESS_DETACH</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">MH_Uninitialize</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>That is a really basic DLL with no error handling whatsoever and hardcoded offset (they never change anyway, but yea..)</p><p>Well, I guess that’s it. We were looking for copper but also found gold along the way. Thank you for reading my first article!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/re/'>re</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/yakuza-kiwami/" class="post-tag no-text-decoration" >yakuza kiwami</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Disabling 'Dying Walk' in Yakuza Kiwami - ibl[og]dzn&url=https://ibldzn.github.io/posts/disabling-dying-walk-kiwami/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Disabling 'Dying Walk' in Yakuza Kiwami - ibl[og]dzn&u=https://ibldzn.github.io/posts/disabling-dying-walk-kiwami/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Disabling 'Dying Walk' in Yakuza Kiwami - ibl[og]dzn&url=https://ibldzn.github.io/posts/disabling-dying-walk-kiwami/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/disabling-dying-walk-kiwami/">Disabling 'Dying Walk' in Yakuza Kiwami</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/yakuza-kiwami/">yakuza kiwami</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></span> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/ibldzn">ibldzn</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/yakuza-kiwami/">yakuza kiwami</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ibldzn.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
